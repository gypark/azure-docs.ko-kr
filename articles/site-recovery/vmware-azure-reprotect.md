---
title: VMware VM 및 물리적 서버의 재해 복구 중에 Azure에서 온-프레미스 사이트로 VM 다시 보호 | Microsoft Docs
description: VMware VM 및 물리적 서버의 재해 복구 중에 Azure로 장애 조치(failover) 후 Azure에서 온-프레미스 사이트로 장애 복구(failback)하는 방법을 알아봅니다.
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 3/12/2019
ms.author: mayg
ms.openlocfilehash: 4202d95b540efb98b526f8a8abd17da22a908ebe
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/23/2019
ms.locfileid: "60482934"
---
# <a name="reprotect-and-fail-back-machines-to-an-on-premises-site-after-failover-to-azure"></a>Azure로 장애 조치(failover) 후에 머신을 온-프레미스 사이트로 다시 보호 및 장애 복구(failback)

Azure로 온-프레미스 VMware VM 및 물리적 서버를 [장애 조치](site-recovery-failover.md)한 후에 온-프레미스 사이트를 장애 복구(Failback)하는 첫 번째 단계는 장애 조치(failover) 중에 생성된 Azure VM을 다시 보호하는 것입니다. 이 문서에서는 이를 수행하는 방법을 설명합니다. 

간략한 개요를 보려면 Azure에서 온-프레미스 사이트로 장애 조치(failover)하는 방법에 대한 다음 동영상을 시청하세요.<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="before-you-begin"></a>시작하기 전에

템플릿을 사용하여 가상 머신을 만든 경우 각 가상 머신에 디스크에 대한 고유한 UUID가 있는지 확인합니다. 온-프레미스 가상 머신의 UUID와 마스터 대상의 UUID가 모두 동일한 템플릿에서 만들어졌기 때문에 두 UUID가 충돌하는 경우 다시 보호에 실패합니다. 동일한 템플릿에서 생성되지 않은 다른 마스터 대상을 배포합니다. 다음 정보에 유의하세요.
- 대체 vCenter로 장애 복구하려고 시도하는 경우 새 vCenter 및 마스터 대상 서버가 검색되는지 확인합니다. 일반적인 증상으로 **다시 보호** 대화 상자에서 데이터 저장소에 액세스할 수 없거나 데이터 저장소를 볼 수 없습니다.
- 온-프레미스로 다시 복제하려면 장애 복구 정책이 필요합니다. 이 정책은 정방향 정책을 만들 때 자동으로 만들어집니다. 다음 정보에 유의하세요.
    - 이 정책은 만들어지는 동안 구성 서버와 자동으로 연결됩니다.
    - 이 정책은 편집할 수 없습니다.
    - 정책의 설정 값은 (RPO 임계값 = 15분, 복구 지점 보존 기간 = 24시간, 앱 일관성 스냅샷 빈도 = 60분)입니다.
- 다시 보호 및 장애 복구(failback) 중에 온-프레미스 구성 서버는 실행 중이며 연결된 상태여야 합니다.
- vCenter Server에서 장애 복구(failback)하려는 가상 머신을 관리하는 경우 vCenter Server에서 VM을 검색하는 데 [필요한 권한](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)이 있는지 확인해야 합니다.
- 다시 보호하기 전에 마스터 대상 서버에서 스냅샷을 삭제합니다. 온-프레미스 마스터 대상 또는 가상 머신에 스냅샷이 있는 경우 다시 보호가 실패합니다. 가상 머신의 스냅샷은 다시 보호 작업 중에 자동으로 병합됩니다.
- 복제 그룹의 모든 가상 머신은 동일한 운영 체제 유형이어야 합니다(모두 Windows 또는 모두 Linux). 운영 체제가 혼합된 복제 그룹은 현재 다시 보호 및 온-프레미스로 장애 복구(failback)가 지원되지 않습니다. 즉, 마스터 대상이 가상 머신과 동일한 운영 체제이어야 합니다. 복제 그룹의 모든 가상 머신에는 동일한 마스터 대상이 있어야 합니다. 
- 장애 복구를 수행할 때 구성 서버가 온-프레미스에 있어야 합니다. 장애 복구하는 동안 가상 머신이 구성 서버 데이터베이스에 있어야 합니다. 그렇지 않으면 장애 복구가 실패합니다. 정기적으로 예정된 구성 서버 백업을 수행해야 합니다. 재해가 발생한 경우 장애 복구가 작동하도록 동일한 IP 주소로 서버를 복원합니다.
- 다시 보호 및 장애 복구(failback)에는 데이터를 복제하는 S2S(사이트 간) VPN이 필요합니다. 네트워크를 제공하여 Azure에서 장애 조치된 가상 머신이 온-프레미스 구성 서버에 연결(ping)할 수 있습니다. 또한 장애 조치된 가상 머신의 Azure 네트워크에 프로세스 서버를 배포할 수도 있습니다. 이 프로세스 서버도 온-프레미스 구성 서버와 통신할 수 있어야 합니다.
- 다음과 같은 장애 조치(failover) 및 장애 복구(failback)용 포트를 열었는지 확인합니다.

    ![장애 조치 및 장애 복구용 포트](./media/vmware-azure-reprotect/failover-failback.png)

- [포트 및 URL 허용 목록에 대한 필수 구성 요소](vmware-azure-deploy-configuration-server.md#prerequisites)를 모두 참고합니다.

## <a name="deploy-a-process-server-in-azure"></a>Azure에서 프로세스 서버 배포

온-프레미스 사이트에 장애 복구(failback)를 수행하기 전에 Azure에 프로세스 서버가 필요할 수 있습니다.
- 프로세스 서버는 Azure의 보호된 가상 머신에서 데이터를 받은 다음, 온-프레미스 사이트로 데이터를 보냅니다.
- 프로세스 서버와 보호된 가상 머신 간에 대기 시간이 짧은 네트워크가 필요합니다. 일반적으로 Azure에서 프로세스 서버가 필요한지 여부를 결정할 때 대기 시간을 고려해야 합니다.
    - Azure ExpressRoute 연결을 설정하는 경우 가상 머신과 프로세스 서버 간의 대기 시간이 짧기 때문에 온-프레미스 프로세스 서버를 사용하여 데이터를 보낼 수 있습니다.
    - 그러나 S2S VPN만 있으면 Azure에 프로세스 서버를 배포하는 것이 좋습니다.
    - 장애 복구(failback) 중에는 Azure 기반 프로세스 서버를 사용하는 것이 좋습니다. 프로세스 서버가 복제 가상 머신(Azure에서 장애 조치된 시스템)와 가까울수록 복제 성능이 더 높습니다. 개념 증명을 위해 프라이빗 피어링으로 ExpressRoute 및 온-프레미스 프로세스 서버를 사용할 수 있습니다.

Azure에서 프로세스 서버를 배포하려면:

1. Azure에서 프로세스 서버를 배포해야 하는 경우 [장애 복구를 위해 Azure에서 프로세스 서버 설정](vmware-azure-set-up-process-server-azure.md)을 참조하세요.
2. Azure VM은 복제 데이터를 프로세스 서버에 전송합니다. Azure VM에서 프로세스 서버에 연결할 수 있도록 네트워크를 구성합니다.
3. Azure에서 온-프레미스로의 복제는 S2S VPN 또는 ExpressRoute 네트워크의 프라이빗 피어링을 통해서만 수행될 수 있습니다. 네트워크 채널을 통해 충분한 대역폭을 사용할 수 있는지 확인합니다.

## <a name="deploy-a-separate-master-target-server"></a>개별 마스터 대상 서버 배포

마스터 대상 서버는 장애 복구(Failback) 데이터를 받습니다. 기본적으로 마스터 대상 서버는 온-프레미스 구성 서버에서 실행됩니다. 그러나 장애 복구된 트래픽의 양에 따라 장애 복구를 위한 별도의 마스터 대상 서버를 만들어야 할 수도 있습니다. 만드는 방법은 다음과 같습니다.

* Linux VM의 장애 복구(failback)를 위해 [Linux 마스터 대상 서버를 만듭니다](vmware-azure-install-linux-master-target.md). 이것은 필수입니다. LVM의 마스터 대상 서버는 지원되지 않습니다.
* 필요에 따라 Windows VM 장애 복구(failback)에 대한 별도의 마스터 대상 서버를 만듭니다. 이 작업을 수행하려면 통합 설치를 다시 실행하고 마스터 대상 서버를 만들도록 선택합니다. [자세히 알아보기](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers). 

마스터 대상 서버를 만든 후에 다음과 같은 작업을 수행합니다.

- 가상 머신이 vCenter 서버의 온-프레미스에 있는 경우 마스터 대상 서버는 온-프레미스 가상 머신의 VMDK(가상 머신 디스크) 파일에 액세스해야 합니다. 복제된 데이터를 가상 머신의 디스크에 쓰려면 액세스 권한이 필요합니다. 읽기/쓰기 액세스 권한으로 온-프레미스 가상 머신의 데이터 저장소를 마스터 대상의 호스트에 탑재했는지 확인합니다.
- 가상 머신이 vCenter 서버의 온-프레미스에 없는 경우 Site Recovery 서비스를 통해 다시 보호하는 중에 새 가상 머신을 만들어야 합니다. 이 가상 머신은 마스터 대상을 만드는 ESX 호스트에서 만들어집니다. ESX 호스트를 신중하게 선택하여 원하는 호스트에 장애 복구 가상 머신을 만듭니다.
- 마스터 대상 서버에 Storage vMotion을 사용할 수 없습니다. 마스터 대상 서버에 Storage vMotion을 사용하면 장애 복구가 실패할 수 있습니다. 디스크를 사용할 수 없으므로 가상 머신을 시작할 수 없습니다. 이 문제가 발생하지 않도록 방지하려면 vMotion 목록에서 마스터 대상 서버를 제외합니다.
- 마스터 대상에서 다시 보호 후 Storage vMotion 작업을 수행하는 경우 마스터 대상에 연결되어 있는 보호된 가상 머신 디스크가 vMotion 작업 대상으로 마이그레이션됩니다. 이 작업 후 장애 복구(failback)를 수행하려고 하면 디스크가 없으므로 디스크 분리에 실패합니다. 그러면 저장소 계정에서 디스크를 찾기가 어려워집니다. 디스크를 수동으로 찾아 가상 머신에 연결해야 합니다. 그리고 나면 온-프레미스 가상 머신을 부팅할 수 있습니다.
- 기존 Windows 마스터 대상 서버에 새 보존 드라이브를 추가합니다. 새 디스크를 추가하고 드라이브를 포맷합니다. 보존 드라이브는 가상 머신에서 온-프레미스 사이트로 다시 복제할 때 특정 시점을 중지하는 데 사용됩니다. 보존 드라이브에 대한 몇 가지 기준을 따릅니다. 이러한 기준이 충족되지 않으면 드라이브가 마스터 대상 서버에 나열되지 않습니다.
    - 볼륨은 복제 대상 등 다른 용도로 사용되지 않습니다.
    - 볼륨은 잠금 모드 상태가 아닙니다.
    - 볼륨은 캐시 볼륨이 아닙니다. 마스터 대상 설치는 해당 볼륨에 없어야 합니다. 프로세스 서버와 마스터 대상에 대한 사용자 지정 설치 볼륨은 보존 볼륨에 적합하지 않습니다. 프로세스 서버와 마스터 대상이 볼륨에 설치되면 이 볼륨은 마스터 대상의 캐시 볼륨입니다.
    - 볼륨의 파일 시스템 형식은 FAT 또는 FAT32가 아닙니다.
    - 볼륨 용량은 0이 아닌 값입니다.
    - Windows의 기본 보존 볼륨은 R 볼륨입니다.
    - Linux의 기본 보존 볼륨은 /mnt/retention입니다.
- 기존 프로세스 서버/구성 서버 컴퓨터 또는 스케일이나 프로세스 서버/마스터 대상 서버 컴퓨터를 사용하는 경우 새 드라이브를 추가해야 합니다. 새 드라이브는 위의 요구 사항을 충족해야 합니다. 보존 드라이브가 없으면 포털의 드롭다운 목록에 선택 사항이 나열되지 않습니다. 온-프레미스 마스터 대상에 드라이브를 추가하고 나면 드라이브가 포털의 선택 사항에 나타나는 데 최대 15분이 걸립니다. 15분 후에도 드라이브가 표시되지 않으면 구성 서버를 새로 고칠 수도 있습니다.
- 마스터 대상 서버에 VMware 도구 또는 open-vm-tools를 설치합니다. 도구가 없으면 마스터 대상의 ESXi 호스트에 있는 데이터 저장소를 검색할 수 없습니다.
- VMware의 마스터 대상 가상 머신의 구성 매개 변수에서 `disk.EnableUUID=true` 설정을 지정합니다. 이 행이 없는 경우 추가합니다. 올바르게 탑재할 수 있도록 VMDK에 일관성 있는 UUID를 제공하려면 이 설정이 필요합니다.
- 마스터 대상이 생성되는 ESX 호스트에는 하나 이상의 VMFS(가상 머신 파일 시스템) 데이터 저장소가 연결되어 있어야 합니다. VMFS 데이터 저장소가 연결되지 않은 경우 다시 보호 페이지의 **데이터 저장소** 입력이 비어 있어 계속 진행할 수 없습니다.
- 마스터 대상 서버의 디스크에는 스냅샷이 있을 수 없습니다. 스냅샷이 있으면 다시 보호 및 장애 복구가 실패합니다.
- 마스터 대상에는 Paravirtual SCSI 컨트롤러가 있을 수 없습니다. 컨트롤러는 LSI Logic 컨트롤러 일 수 있습니다. LSI Logic 컨트롤러가 없으면 다시 보호가 실패합니다.
- 인스턴스의 경우 마스터 대상은 최대 60개의 디스크를 연결할 수 있습니다. 온-프레미스 마스터 대상으로 다시 보호된 가상 머신의 수가 총 디스크 수 60개를 초과하면 마스터 대상에 대한 다시 보호가 실패하기 시작합니다. 마스터 대상 디스크 슬롯이 충분한지 확인하거나 추가 마스터 대상 서버를 배포합니다.
    

## <a name="enable-reprotection"></a>다시 보호 사용

Azure에서 가상 머신을 부팅한 후 에이전트에서 구성 서버에 다시 등록하는 데 약간의 시간(최대 15분)이 걸립니다. 이 시간 동안 다시 보호를 사용할 수 없으며 에이전트가 설치되지 않았다는 오류 메시지가 표시됩니다. 그러면 몇 분 동안 기다린 다음, 다시 보호를 다시 시도합니다.


1. **자격 증명 모음** > **복제된 항목**을 선택합니다. 장애 조치된 가상 머신을 마우스 오른쪽 단추로 클릭한 다음, **다시 보호**를 선택합니다. 또는 명령 단추에서 컴퓨터를 선택한 다음, **다시 보호**를 선택합니다.
2. 보호 방향이 **Azure에서 온-프레미스**로 선택되어 있는지 확인합니다.
3. **마스터 대상 서버** 및 **프로세스 서버**에서 온-프레미스 마스터 대상 서버 및 프로세스 서버를 선택합니다.  
4. **데이터 저장소**로는 온-프레미스에서 디스크를 복구하려는 데이터 저장소를 선택합니다. 이 옵션은 온-프레미스 가상 머신이 삭제되고 새 디스크를 만들어야 하는 경우에 사용합니다. 디스크가 이미 존재하는 경우 이 옵션은 무시됩니다. 값을 지정해야 합니다.
5. 보존 드라이브를 선택합니다.
6. 장애 복구 정책이 자동으로 선택됩니다.
7. **확인**을 선택하여 다시 보호를 시작합니다. Azure에서 온-프레미스 사이트로 가상 머신을 복제하는 작업을 시작합니다. **작업** 탭에서 진행률을 추적할 수 있습니다. 다시 보호가 성공하면 가상 머신이 보호된 상태가 됩니다.

다음 정보에 유의하세요.
- 대체 위치로 복구하려는 경우(온-프레미스 가상 머신이 삭제된 경우) 마스터 대상 서버에 대해 구성된 보존 드라이브와 데이터 저장소를 선택합니다. 온-프레미스 사이트로 장애 복구할 때 장애 복구 보호 계획에 있는 VMware 가상 머신에서 마스터 대상 서버와 동일한 데이터 저장소를 사용합니다. 새 가상 머신이 vCenter에 만들어집니다.
- Azure의 가상 머신을 기존의 온-프레미스 가상 머신에 복구하려면 읽기/쓰기 액세스 권한으로 온-프레미스 가상 머신의 데이터 저장소를 마스터 대상 서버의 ESXi 호스트에 탑재합니다.

    ![다시 보호 대화 상자](./media/vmware-azure-reprotect/reprotectinputs.png)

- 또한 복구 계획 수준에서 다시 보호할 수 있습니다. 복제 그룹은 복구 계획을 통해서만 다시 보호할 수 있습니다. 복구 계획을 사용하여 다시 보호하는 경우 보호된 모든 컴퓨터에 값을 제공해야 합니다.
- 복제 그룹을 다시 보호하기 위해 동일한 마스터 대상 서버를 사용합니다. 다른 마스터 대상 서버를 사용하여 복제 그룹을 보호하는 경우 서버에서 공통된 시점을 제공할 수 없습니다.
- 온-프레미스 가상 머신이 다시 보호 중에 꺼집니다. 이렇게 하면 복제 중 데이터 일관성을 보장할 수 있습니다. 다시 보호가 완료된 후에 가상 머신을 켜지 않습니다.



## <a name="common-issues"></a>일반적인 문제

- 읽기 전용 사용자 vCenter 검색을 수행하고 가상 머신을 보호하면 보호에 성공하고 장애 조치가 작동합니다. 다시 보호 중에는 데이터 저장소를 검색할 수 없기 때문에 장애 조치가 실패합니다. 증상은 다시 보호 중에 데이터 저장소가 나열되지 않는 것입니다. 이 문제를 해결하려면 vCenter 자격 증명을 권한이 있는 적절한 계정으로 업데이트한 다음, 작업을 다시 시도하면 됩니다. 
- Linux 가상 컴퓨터를 장애 복구하고 온-프레미스에서 실행하면 네트워크 관리자 패키지가 컴퓨터에서 제거되었음을 알 수 있습니다. Azure에서 가상 머신을 복구할 때 네트워크 관리자 패키지가 제거되었기 때문에 이 기능이 제거됩니다.
- Linux 가상 머신을 고정 IP 주소로 구성하고 Azure로 장애 조치하면 DHCP에서 IP 주소를 가져옵니다. 온-프레미스로 장애 조치하면 가상 머신에서 계속 DHCP를 사용하여 IP 주소를 가져옵니다. 컴퓨터에 수동으로 로그인한 다음, 필요한 경우 IP 주소를 고정 주소로 다시 설정합니다. Windows 가상 머신에서는 고정 IP 주소를 다시 얻을 수 있습니다.
- ESXi 5.5 체험 버전 또는 vSphere 6 하이퍼바이저 체험 버전을 사용하는 경우 장애 조치는 성공하지만 장애 복구가 실패합니다. 장애 복구를 사용하도록 설정하려면 평가판 라이선스로 업그레이드합니다.
- 프로세스 서버에서 구성 서버에 연결할 수 없는 경우 텔넷을 사용하여 443 포트에서 구성 서버에 대한 연결을 확인합니다. 프로세스 서버에서 구성 서버를 ping할 수도 있습니다. 또한 프로세스 서버에는 구성 서버에 연결될 때 하트비트도 있어야 합니다.
- 물리적 온-프레미스 서버로 보호되는 Windows Server 2008 R2 SP1 서버는 Azure에서 온-프레미스 사이트로 장애 복구할 수 없습니다.
- 다음과 같은 경우에 장애 복구(failback)를 수행할 수 없습니다.
    - Azure에 컴퓨터를 마이그레이션했습니다. [자세히 알아보기](migrate-overview.md#what-do-we-mean-by-migration).
    - 다른 리소스 그룹으로 VM을 이동했습니다.
    - Azure VM을 삭제했습니다.
    - VM의 보호를 해제했습니다.
    - Azure에서 VM을 수동으로 만들었습니다. 컴퓨터가 처음에 온-프레미스로 보호되고 다시 보호되기 전에 Azure로 장애 조치(failover)되었어야 합니다.
    - ESXi 호스트에 대해서만 실패할 수 있습니다. VMware VM 또는 Hyper-V 호스트, 물리적 서버 또는 VMware 워크스테이션에 대한 물리적 서버를 장애 복구(failback)할 수 없습니다.


## <a name="next-steps"></a>다음 단계

가상 머신이 보호된 상태가 되면 [장애 복구를 시작](vmware-azure-failback.md)할 수 있습니다. 장애 복구는 Azure에서 가상 머신을 종료하고 온-프레미스 가상 머신을 부팅합니다. 애플리케이션에 약간의 가동 중지 시간이 예상됩니다. 애플리케이션에서 가동 중지 시간을 허용할 수 있는 경우 장애 복구 시간을 선택합니다.


